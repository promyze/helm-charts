apiVersion: apps/v1
kind: Deployment
metadata:
  name: app
spec:
  selector:
    matchLabels:
      component: app
  template:
    metadata:
      labels:
        component: app
    spec:
      containers:
        - name: app
          image: {{ .Values.app.image }}
          imagePullPolicy: Always
          ports:
            - containerPort: 3001
          livenessProbe:
           httpGet:
             path: /open/getPromyzeEnv
             port: 3001
           initialDelaySeconds: 30
           periodSeconds: 20
          env:
            - name: MONGO_URI
              {{- if $.Values.app.mongo.secret }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.app.mongo.secret.name }}
                  key: {{ .Values.app.mongo.secret.key }}
              {{- end }}
              {{- if $.Values.app.mongo.uri }}
              value: {{ .Values.app.mongo.uri }}
              {{- end }}
            {{- range $key, $value := .Values.app.variables }}
            - name: {{ $key }}
              value: {{ $value | quote }}
            {{- end }}
            {{- range $key, $value := .Values.app.secrets }}
            - name: {{ $value.envVariable }}
              valueFrom:
                secretKeyRef:
                  name: {{ $value.secretName }}
                  key: {{ $value.secretKey }}
            {{- end }}
{{ if .Values.app.mongo.embedded }}
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mongodb
spec:
  selector:
    matchLabels:
      component: mongodb
  template:
    metadata:
      labels:
        component: mongodb
    spec:
      containers:
        - name: mongodb
          image: mongo:4.4
          ports:
            - containerPort: 27017
{{ end }}
